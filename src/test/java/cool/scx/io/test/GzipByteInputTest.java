package cool.scx.io.test;

import cool.scx.io.DefaultByteInput;
import cool.scx.io.adapter.ByteInputAdapter;
import cool.scx.io.exception.AlreadyClosedException;
import cool.scx.io.exception.NoMatchFoundException;
import cool.scx.io.exception.NoMoreDataException;
import cool.scx.io.exception.ScxIOException;
import cool.scx.io.supplier.ByteArrayByteSupplier;
import org.testng.Assert;
import org.testng.annotations.Test;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.zip.GZIPInputStream;
import java.util.zip.GZIPOutputStream;

public class GzipByteInputTest {

    public static void main(String[] args) throws IOException, AlreadyClosedException, NoMatchFoundException, ScxIOException {
        test1();
    }

    private static byte[] toGzipBytes(byte[] b) throws IOException {
        var bao = new ByteArrayOutputStream();
        var gzip = new GZIPOutputStream(bao);
        gzip.write(b);
        gzip.close();
        return bao.toByteArray();
    }

    @Test
    public static void test1() throws IOException, AlreadyClosedException, NoMatchFoundException, ScxIOException {
        var rawStr = "1234567890üòÄü•Äüë®‚Äçü¶∞üåµ‰∏≠Êñá!@$%^&*()()";
        var rawData = rawStr.getBytes();

        var gzipData = toGzipBytes(rawData);

        var s = new ArrayList<byte[]>();
        for (int i = 0; i < 100; i = i + 1) {
            s.add(gzipData);
        }

        s.add(toGzipBytes("\r\n".getBytes()));

        var gzipByteInput = new DefaultByteInput(new ByteArrayByteSupplier(s));

        var byteInput = ByteInputAdapter.inputStreamToByteInput(new GZIPInputStream(ByteInputAdapter.byteInputToInputStream(gzipByteInput)));

        while (true) {
            try {
                // ÊØèÊ¨° ËØªÂèñÁöÑÂ∫îËØ•ÈÉΩÊòØ Âíå Êèê‰æõÂô®Êèê‰æõÁöÑ‰∏ÄÊ†∑ (‰πüÂ∞±ÊòØÈùûÈòªÂ°ûËØªÂèñ)
                var data = byteInput.readUntil("\r\n".getBytes());
                var str = new String(data);

                Assert.assertEquals(str, rawStr.repeat(100));
            } catch (NoMoreDataException e) {
                // ÂøΩÁï•
                break;
            }
        }

    }

}
